name: Build and Release

permissions:
  contents: write

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.0.0)"
        required: true
        default: "1.0.0"

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5 # v5 daha gÃ¼ncel ve hÄ±zlÄ±dÄ±r
        with:
          python-version: "3.11"
          cache: "pip" # BaÄŸÄ±mlÄ±lÄ±klarÄ± Ã¶nbelleÄŸe alÄ±r

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          if (Test-Path requirements.txt) { pip install -r requirements.txt }

      - name: Build executable with PyInstaller
        run: |
          pyinstaller --onefile --console --name "Flarion-Ping-Tester" --add-data "Data;Data" main.py

      - name: Get version
        id: get_version
        shell: powershell
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $ver = "${{ github.event.inputs.version }}"
          } else {
            $ver = "${{ github.ref_name }}" # v1.0.0 gibi kÄ±sa ismi alÄ±r
          }
          echo "version=$ver" >> $env:GITHUB_OUTPUT

      - name: Create release directory and copy files
        run: |
          New-Item -ItemType Directory -Path "release" -Force
          New-Item -ItemType Directory -Path "release\Data" -Force
          Copy-Item "dist\Flarion-Ping-Tester.exe" "release\" -Force
          if (Test-Path "Data\datacenters.json") { Copy-Item "Data\datacenters.json" "release\Data\" -Force }
          # README oluÅŸturma kÄ±smÄ± (mevcut kodunuzla aynÄ± kalabilir)
          Set-Content -Path "release\README.md" -Value "# Flarion Universal Ping Tester CLI`n`nA command-line tool..."

      - name: Create ZIP archive
        run: |
          Compress-Archive -Path "release\*" -DestinationPath "Flarion-Ping-Tester-v${{ steps.get_version.outputs.version }}.zip" -Force

      - name: Create Release
        # Hem tag push edildiÄŸinde hem de manuel baÅŸlatÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r
        if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          # Manuel tetiklemede version input'unu, tag'de ise tag ismini kullanÄ±r
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Release v${{ steps.get_version.outputs.version }}
          files: Flarion-Ping-Tester-v${{ steps.get_version.outputs.version }}.zip
          body: |
            ## Flarion Universal Ping Tester CLI v${{ steps.get_version.outputs.version }}
            ðŸš€ Otomatik oluÅŸturulan sÃ¼rÃ¼m.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build-Artifacts-v${{ steps.get_version.outputs.version }}
          path: Flarion-Ping-Tester-v${{ steps.get_version.outputs.version }}.zip
          retention-days: 7
